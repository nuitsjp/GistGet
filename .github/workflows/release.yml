# GistGet ãƒªãƒªãƒ¼ã‚¹ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼
# ã‚¿ã‚°ãƒ—ãƒƒã‚·ãƒ¥æ™‚ã«è‡ªå‹•ã§ GitHub Releases ã‚’ä½œæˆã—ã€winget-pkgs ã¸ã® PR ã‚’è‡ªå‹•ç”Ÿæˆ

name: Release

on:
  push:
    tags:
      - 'v*.*.*'  # v0.1.0, v1.0.0 ãªã©

permissions:
  contents: write

env:
  DOTNET_VERSION: '10.0.x'
  PROJECT_PATH: 'src/GistGet/GistGet.csproj'

jobs:
  ci:
    name: CI validation
    uses: ./.github/workflows/ci.yml
    secrets: inherit

  build:
    name: Build (${{ matrix.rid }})
    needs: ci
    runs-on: windows-latest
    strategy:
      matrix:
        include:
          - rid: win-x64
            arch: x64
          - rid: win-arm64
            arch: arm64

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: ${{ env.DOTNET_VERSION }}

      - name: Get version from tag
        id: version
        shell: pwsh
        run: |
          $version = "${{ github.ref_name }}" -replace '^v\.?', ''
          $version = $version.TrimStart('.')

          if ([string]::IsNullOrWhiteSpace($version)) {
            throw "Failed to parse version from tag '${{ github.ref_name }}'."
          }

          echo "VERSION=$version" >> $env:GITHUB_OUTPUT
          echo "Version: $version"

      - name: Build and Publish
        shell: pwsh
        run: |
          $publishPath = "artifacts/publish/${{ matrix.rid }}"
          dotnet publish ${{ env.PROJECT_PATH }} `
            -c Release `
            -r ${{ matrix.rid }} `
            -o $publishPath `
            -p:Version=${{ steps.version.outputs.VERSION }} `
            --self-contained true

      - name: Create ZIP archive
        shell: pwsh
        run: |
          $zipName = "GistGet-${{ matrix.rid }}.zip"
          Compress-Archive -Path "artifacts/publish/${{ matrix.rid }}/*" -DestinationPath "artifacts/$zipName" -Force
          
          # SHA256 ãƒãƒƒã‚·ãƒ¥ã‚’è¨ˆç®—
          $hash = (Get-FileHash -Path "artifacts/$zipName" -Algorithm SHA256).Hash
          echo "SHA256=$hash" >> $env:GITHUB_OUTPUT
          echo "$hash  $zipName" | Out-File -FilePath "artifacts/$zipName.sha256" -Encoding UTF8
          
          echo "Created: $zipName"
          echo "SHA256: $hash"
        id: zip

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: GistGet-${{ matrix.rid }}
          path: |
            artifacts/GistGet-${{ matrix.rid }}.zip
            artifacts/GistGet-${{ matrix.rid }}.zip.sha256

  release:
    name: Create Release
    needs: build
    runs-on: ubuntu-latest

    outputs:
      version: ${{ steps.version.outputs.VERSION }}
      x64_sha256: ${{ steps.hashes.outputs.X64_SHA256 }}
      arm64_sha256: ${{ steps.hashes.outputs.ARM64_SHA256 }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Get version from tag
        id: version
        run: |
          VERSION="${GITHUB_REF_NAME#v}"
          VERSION="${VERSION#.}"

          if [ -z "$VERSION" ]; then
            echo "Failed to parse version from tag '${GITHUB_REF_NAME}'." >&2
            exit 1
          fi
          echo "VERSION=$VERSION" >> $GITHUB_OUTPUT
          echo "Version: $VERSION"

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts
          merge-multiple: true

      - name: Extract SHA256 hashes
        id: hashes
        run: |
          X64_HASH=$(cat artifacts/GistGet-win-x64.zip.sha256 | cut -d' ' -f1)
          ARM64_HASH=$(cat artifacts/GistGet-win-arm64.zip.sha256 | cut -d' ' -f1)
          echo "X64_SHA256=$X64_HASH" >> $GITHUB_OUTPUT
          echo "ARM64_SHA256=$ARM64_HASH" >> $GITHUB_OUTPUT
          echo "x64 SHA256: $X64_HASH"
          echo "arm64 SHA256: $ARM64_HASH"

      - name: Create SHA256SUMS.txt
        run: |
          cat artifacts/GistGet-win-x64.zip.sha256 > artifacts/SHA256SUMS.txt
          cat artifacts/GistGet-win-arm64.zip.sha256 >> artifacts/SHA256SUMS.txt

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          name: GistGet v${{ steps.version.outputs.VERSION }}
          body: |
            ## GistGet v${{ steps.version.outputs.VERSION }}
            
            Windows Package Manager Cloud Sync Tool
            
            ### ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«æ–¹æ³•
            
            #### WinGet (æ¨å¥¨)
            ```powershell
            winget install nuitsjp.GistGet
            ```
            
            #### æ‰‹å‹•ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
            1. ãŠä½¿ã„ã®ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£ã«å¯¾å¿œã—ãŸ ZIP ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
            2. ä»»æ„ã®ãƒ•ã‚©ãƒ«ãƒ€ã«å±•é–‹
            3. å±•é–‹ã—ãŸãƒ•ã‚©ãƒ«ãƒ€ã‚’ PATH ç’°å¢ƒå¤‰æ•°ã«è¿½åŠ 
            
            ### ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
            | ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£ | ãƒ•ã‚¡ã‚¤ãƒ« | SHA256 |
            |---------------|----------|--------|
            | x64 | GistGet-win-x64.zip | `${{ steps.hashes.outputs.X64_SHA256 }}` |
            | ARM64 | GistGet-win-arm64.zip | `${{ steps.hashes.outputs.ARM64_SHA256 }}` |
            
            ### å¤‰æ›´ç‚¹
            è©³ç´°ã¯ [CHANGELOG](https://github.com/nuitsjp/GistGet/blob/main/CHANGELOG.md) ã‚’å‚ç…§ã—ã¦ãã ã•ã„ã€‚
          files: |
            artifacts/GistGet-win-x64.zip
            artifacts/GistGet-win-arm64.zip
            artifacts/SHA256SUMS.txt
          draft: false
          prerelease: ${{ contains(github.ref_name, '-') }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  winget-publish:
    name: Publish to WinGet
    needs: release
    runs-on: windows-latest
    # ãƒ—ãƒ¬ãƒªãƒªãƒ¼ã‚¹ã®å ´åˆã¯ WinGet ã¸ã®ç™ºè¡Œã‚’ã‚¹ã‚­ãƒƒãƒ—
    if: ${{ !contains(github.ref_name, '-') }}

    outputs:
      pr_url: ${{ steps.submit.outputs.PR_URL }}

    steps:
      - name: Install wingetcreate
        shell: pwsh
        run: |
          # wingetcreate ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
          Invoke-WebRequest -Uri https://aka.ms/wingetcreate/latest -OutFile wingetcreate.exe

      - name: Submit to WinGet
        id: submit
        shell: pwsh
        env:
          WINGET_GITHUB_TOKEN: ${{ secrets.WINGET_GITHUB_TOKEN }}
        run: |
          $version = "${{ needs.release.outputs.version }}"
          $x64Url = "https://github.com/nuitsjp/GistGet/releases/download/v$version/GistGet-win-x64.zip"
          $arm64Url = "https://github.com/nuitsjp/GistGet/releases/download/v$version/GistGet-win-arm64.zip"
          
          # wingetcreate ã§ PR ã‚’ä½œæˆã—ã€å‡ºåŠ›ã‚’ã‚­ãƒ£ãƒ—ãƒãƒ£
          # æ³¨æ„: WINGET_GITHUB_TOKEN ã¯ winget-pkgs ãƒªãƒã‚¸ãƒˆãƒªã¸ã®æ›¸ãè¾¼ã¿æ¨©é™ã‚’æŒã¤ PAT
          $output = ./wingetcreate.exe update nuitsjp.GistGet `
            --version $version `
            --urls $x64Url $arm64Url `
            --submit `
            --token $env:WINGET_GITHUB_TOKEN 2>&1 | Out-String
          
          Write-Host $output
          
          # PR URL ã‚’æŠ½å‡º (wingetcreate ã¯ "Pull request can be found at: <URL>" å½¢å¼ã§å‡ºåŠ›)
          if ($output -match 'https://github\.com/microsoft/winget-pkgs/pull/\d+') {
            $prUrl = $Matches[0]
            echo "PR_URL=$prUrl" >> $env:GITHUB_OUTPUT
            Write-Host "Extracted PR URL: $prUrl"
          } else {
            Write-Host "Warning: Could not extract PR URL from wingetcreate output"
            echo "PR_URL=" >> $env:GITHUB_OUTPUT
          }

  summary:
    name: Release Summary
    needs: [release, winget-publish]
    runs-on: ubuntu-latest
    # winget-publish ãŒã‚¹ã‚­ãƒƒãƒ—ã•ã‚Œã¦ã‚‚å®Ÿè¡Œ
    if: ${{ always() && needs.release.result == 'success' }}

    steps:
      - name: Generate Summary
        env:
          VERSION: ${{ needs.release.outputs.version }}
          PR_URL: ${{ needs.winget-publish.outputs.pr_url }}
          WINGET_RESULT: ${{ needs.winget-publish.result }}
        run: |
          RELEASE_URL="https://github.com/${{ github.repository }}/releases/tag/${{ github.ref_name }}"
          
          echo "## ğŸš€ ãƒªãƒªãƒ¼ã‚¹å®Œäº†" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### GitHub Release" >> $GITHUB_STEP_SUMMARY
          echo "- **ãƒãƒ¼ã‚¸ãƒ§ãƒ³**: v${VERSION}" >> $GITHUB_STEP_SUMMARY
          echo "- **ãƒªãƒªãƒ¼ã‚¹ãƒšãƒ¼ã‚¸**: [GistGet v${VERSION}](${RELEASE_URL})" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ "$WINGET_RESULT" = "success" ] && [ -n "$PR_URL" ]; then
            echo "### WinGet" >> $GITHUB_STEP_SUMMARY
            echo "- **ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹**: âœ… PR ä½œæˆæ¸ˆã¿" >> $GITHUB_STEP_SUMMARY
            echo "- **Pull Request**: [winget-pkgs PR](${PR_URL})" >> $GITHUB_STEP_SUMMARY
          elif [ "$WINGET_RESULT" = "success" ]; then
            echo "### WinGet" >> $GITHUB_STEP_SUMMARY
            echo "- **ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹**: âœ… é€ä¿¡å®Œäº†ï¼ˆPR URL å–å¾—ä¸å¯ï¼‰" >> $GITHUB_STEP_SUMMARY
          elif [ "$WINGET_RESULT" = "skipped" ]; then
            echo "### WinGet" >> $GITHUB_STEP_SUMMARY
            echo "- **ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹**: â­ï¸ ã‚¹ã‚­ãƒƒãƒ—ï¼ˆãƒ—ãƒ¬ãƒªãƒªãƒ¼ã‚¹ã®ãŸã‚ï¼‰" >> $GITHUB_STEP_SUMMARY
          else
            echo "### WinGet" >> $GITHUB_STEP_SUMMARY
            echo "- **ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹**: âŒ å¤±æ•—" >> $GITHUB_STEP_SUMMARY
          fi
